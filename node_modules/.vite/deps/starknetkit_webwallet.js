import {
  Ca,
  Ea,
  La,
  Na,
  Oa,
  Ra,
  Sa,
  fn
} from "./chunk-JPG53TQT.js";
import {
  e,
  s
} from "./chunk-OCOZLJAH.js";
import {
  A,
  M,
  R,
  T
} from "./chunk-IZCIPCCQ.js";
import {
  WalletAccount,
  constants_exports
} from "./chunk-ALJOHPWU.js";
import "./chunk-5N7ZOTW6.js";

// node_modules/starknetkit/dist/webwalletConnector.js
var A2 = Object.defineProperty;
var k = (a, n, s2) => n in a ? A2(a, n, { enumerable: true, configurable: true, writable: true, value: s2 }) : a[n] = s2;
var u = (a, n, s2) => (k(a, typeof n != "symbol" ? n + "" : n, s2), s2);
var L = class extends Error {
  constructor(s2, t) {
    super(s2);
    u(this, "code");
    this.name = "ConnectAndSignSessionError", this.code = t;
  }
};
var B = class extends Error {
  constructor(s2, t) {
    super(s2);
    u(this, "code");
    this.name = "WebwalletError", this.code = t;
  }
};
var q = 385;
var G = 775;
var j = 385;
var z = 440;
var $ = 420;
var F = 438;
var m = [];
var X = (a, n) => ({
  ...a,
  getLoginStatus: () => n.getLoginStatus.mutate(),
  connectWebwallet: (t = {}) => {
    const { theme: e2 } = t;
    return n.connectWebwallet.mutate({
      theme: e2
    });
  },
  connectAndSignSession: (t) => n.connectAndSignSession.mutate(t),
  connectWebwalletSSO: (t, e2) => n.connectWebwalletSSO.mutate({ token: t, authorizedPartyId: e2 }),
  async request(t) {
    switch (t.type) {
      case "wallet_requestAccounts":
        return n.requestAccounts.mutate(t.params);
      case "wallet_signTypedData": {
        const e2 = t.params, o = (e2 == null ? void 0 : e2.primaryType) === "Session" && (e2 == null ? void 0 : e2.domain.name) === "SessionAccount.session";
        Na({
          width: j,
          height: z,
          location: o ? "/signSessionKeys" : "/signMessage"
        });
        const r = Array.isArray(t.params) ? t.params : [t.params];
        return n.signTypedData.mutate(r);
      }
      case "wallet_getPermissions":
        return n.getPermissions.mutate();
      case "wallet_addInvokeTransaction": {
        const e2 = t.params.calls;
        return Na({
          width: q,
          height: G,
          location: "/review"
        }), { transaction_hash: await n.addInvokeTransaction.mutate(e2) };
      }
      case "wallet_requestChainId":
        return await n.requestChainId.mutate();
      case "wallet_addStarknetChain":
        return n.addStarknetChain.mutate(t.params);
      case "wallet_switchStarknetChain":
        return n.switchStarknetChain.mutate(t.params);
      case "wallet_watchAsset":
        return n.watchAsset.mutate();
      case "wallet_deploymentData":
        return n.deploymentData.mutate();
      default:
        throw new Error("not implemented");
    }
  },
  on: (t, e2) => {
    if (t === "accountsChanged")
      m.push({
        type: t,
        handler: e2
      });
    else if (t === "networkChanged")
      m.push({
        type: t,
        handler: e2
      });
    else
      throw new Error(`Unknwown event: ${t}`);
  },
  off: (t, e2) => {
    if (t !== "accountsChanged" && t !== "networkChanged")
      throw new Error(`Unknwown event: ${t}`);
    const o = m.findIndex(
      (r) => r.type === t && r.handler === e2
    );
    o >= 0 && m.splice(o, 1);
  }
});
var J = (a) => {
  a.style.display = "none", a.style.borderRadius = "40px", a.style.inset = "0", a.style.position = "fixed", a.style.top = "50%", a.style.left = "50%", a.style.transform = "translate(-50%, -50%)", a.style.backgroundColor = "transparent", a.style.zIndex = "999999", a.style.height = `${F}px`, a.style.width = `${$}px`;
};
var K = (a, n) => {
  a.style.display = "block", n.style.display = "block";
};
var Q = (a, n) => {
  a.style.display = "none", n.style.display = "none";
};
var V = (a, n, s2) => {
  a.style.width = `${n}px`, a.style.height = `${s2}px`;
};
var I = "argent-webwallet-iframe";
var Y = async (a, n) => {
  var _a;
  const s2 = "argent-webwallet-backdrop", t = new URL(a);
  t.pathname = "/iframes/comms", a = t.toString();
  const e2 = document.createElement("iframe");
  e2.src = a, e2.loading = "eager", e2.sandbox.add(
    "allow-scripts",
    "allow-same-origin",
    "allow-forms",
    "allow-top-navigation",
    "allow-popups"
  ), e2.allow = "clipboard-write", e2.id = I, e2.setAttribute("allowtransparency", "true"), e2.setAttribute("transparent", "true"), J(e2), e2.style.display = n ? "block" : "none";
  const o = document.createElement("div");
  o.id = s2, o.style.position = "fixed", o.style.inset = "0", o.style.backgroundColor = "rgba(0,0,0,0.5)", o.style.zIndex = "999998", o.style.width = "100dvw", o.style.height = "100dvh", o.style.backdropFilter = "blur(4px)";
  const r = document.getElementById(I);
  return r && (r.remove(), (_a = document.getElementById(s2)) == null ? void 0 : _a.remove()), window.document.body.appendChild(e2), await new Promise((i, c) => {
    const w = setTimeout(
      () => c(new Error("Timeout while loading an iframe")),
      2e4
    );
    e2.addEventListener("load", async () => {
      clearTimeout(w), i();
    });
  }), window.document.body.appendChild(o), { iframe: e2, backdrop: o };
};
var y = async (a, n, s2) => {
  const t = typeof window < "u" ? window : void 0;
  if (!t)
    throw new Error("window is not defined");
  const e2 = X(
    {
      host: t.location.origin,
      id: "argentWebWallet",
      icon: "https://www.ready.co/favicon.ico",
      name: "Web Wallet",
      version: "1.0.0"
    },
    n
  );
  if (s2) {
    const { iframe: o, backdrop: r } = s2;
    n.updateModal.subscribe(void 0, {
      onData(i) {
        switch (i.action) {
          case "show":
            K(o, r);
            break;
          case "hide":
            Q(o, r);
            break;
          case "updateSize":
            V(o, i.width, i.height);
            break;
        }
      }
    });
  }
  return e2;
};
var W = "allowed-dapps";
var Z = async (a) => {
  const n = a === constants_exports.NetworkName.SN_MAIN ? Ra : Ca;
  try {
    const t = await (await caches.open(W)).match(n);
    if (t) {
      const w = parseInt(
        t.headers.get("X-Cache-Timestamp") ?? "0",
        10
      );
      if (((/* @__PURE__ */ new Date()).getTime() - w) / (1e3 * 60 * 60) < 24)
        return t.json();
    }
    const e2 = await fetch(n), o = new Headers(e2.headers);
    o.set("X-Cache-Timestamp", (/* @__PURE__ */ new Date()).getTime().toString());
    const r = await e2.json(), i = new Response(JSON.stringify(r), {
      status: e2.status,
      statusText: e2.statusText,
      headers: o
    });
    return await (await caches.open(W)).put(n, i), r;
  } catch (s2) {
    throw new Error(s2);
  }
};
var tt = async (a) => new Promise((n) => {
  if (!a)
    return n(false);
  try {
    navigator.webkitTemporaryStorage.queryUsageAndQuota(
      (t, e2) => {
        var _a;
        n(
          Math.round(e2 / (1024 * 1024)) < Math.round(
            (((_a = performance == null ? void 0 : performance.memory) == null ? void 0 : _a.jsHeapSizeLimit) ?? 1073741824) / (1024 * 1024)
          ) * 2
        );
      },
      () => n(false)
    );
  } catch {
    n(false);
  }
});
var et = async (a) => {
  const { userAgent: n } = navigator, s2 = !!(navigator.vendor && navigator.vendor.indexOf("Google") === 0 && navigator.brave === void 0 && !n.match(/Edg/) && !n.match(/OPR/)), t = await tt(s2);
  if (!s2 || t) {
    const r = La({});
    return await y(
      a,
      r,
      void 0
    );
  }
  const e2 = Sa(a), { allowedDapps: o } = await Z(e2);
  if (o.includes(window.location.hostname)) {
    const r = "argent-webwallet-backdrop", i = "argent-webwallet-iframe", c = document.getElementById(r), w = document.getElementById(i);
    w && w && c && (w.remove(), c.remove());
    const { iframe: p, backdrop: f } = await Y(a, false), b = La({
      iframe: p.contentWindow ?? void 0
    });
    return await y(
      a,
      b,
      { iframe: p, backdrop: f }
    );
  } else {
    const r = La({});
    return await y(
      a,
      r,
      void 0
    );
  }
};
var P = "webwallet_logout";
var l = null;
var h = null;
var lt = class extends M {
  constructor(s2 = {}) {
    super();
    u(this, "_wallet", null);
    u(this, "_options");
    this._options = s2;
  }
  available() {
    return true;
  }
  async ready() {
    if (this._wallet || await this.ensureWallet(), this._wallet)
      try {
        return (await this._wallet.request({
          type: "wallet_getPermissions"
        })).includes(e.ACCOUNTS);
      } catch {
        return false;
      }
    else
      return this._wallet = null, h = null, false;
  }
  get id() {
    var _a;
    return this._wallet = l, ((_a = this._wallet) == null ? void 0 : _a.id) || "argentWebWallet";
  }
  get name() {
    var _a;
    return this._wallet = l, ((_a = this._wallet) == null ? void 0 : _a.name) || "Web Wallet";
  }
  get icon() {
    return {
      light: Ea,
      dark: Ea
    };
  }
  get wallet() {
    if (!this._wallet)
      throw new A();
    return this._wallet;
  }
  get title() {
    return "Email";
  }
  get subtitle() {
    return "Powered by Ready";
  }
  async connectAndSignSession({
    callbackData: s2,
    approvalRequests: t,
    sessionTypedData: e2
  }) {
    if (this._wallet || await this.ensureWallet(), !this._wallet)
      throw new R();
    try {
      return await this._wallet.connectAndSignSession({
        callbackData: s2,
        approvalRequests: t,
        sessionTypedData: e2,
        theme: this._options.theme
      });
    } catch (o) {
      if (o instanceof Error && (o.constructor.name === "TRPCClientError" || o.name === "TRPCClientError")) {
        const r = o, i = r.shape.data.webwalletErrorMessage || r.message, c = r.shape.data.webwalletErrorCode || r.shape.message;
        throw new L(i, c);
      }
      throw new Error(o instanceof Error ? o.message : String(o));
    }
  }
  async connect(s2 = {}) {
    if (this._wallet || await this.ensureWallet(), !this._wallet)
      throw new R();
    try {
      let t, e2;
      if (this._options.ssoToken) {
        const r = await this._wallet.connectWebwalletSSO(
          this._options.ssoToken,
          this._options.authorizedPartyId
        );
        t = r.account, e2 = r.chainId;
      } else {
        const r = await this._wallet.connectWebwallet({
          theme: this._options.theme
        });
        t = r.account, e2 = r.chainId;
      }
      if (!t || !e2)
        return {};
      const o = Oa(e2);
      return h = t[0], {
        account: t[0],
        chainId: BigInt(o)
      };
    } catch {
      throw new T();
    }
  }
  async request(s2) {
    if (this._wallet || await this.ensureWallet(), !this._wallet)
      throw new A();
    try {
      return await this._wallet.request(s2);
    } catch (t) {
      if (t instanceof Error && (t.constructor.name === "TRPCClientError" || t.name === "TRPCClientError")) {
        const e2 = t, o = e2.shape.data.webwalletErrorMessage || e2.message, r = e2.shape.data.webwalletErrorCode || e2.shape.message;
        throw r === "USER_LOGGED_OUT" && (l = null, h = null, this._wallet = null, document.dispatchEvent(new Event(P))), new B(o, r);
      }
      throw new T();
    }
  }
  async disconnect() {
    if (!this.available() && !this._wallet)
      throw new R();
    l = null, h = null, this._wallet = l, s();
  }
  async account(s2) {
    if (this._wallet = l, !this._wallet)
      throw new A();
    if (!h)
      throw new A();
    return new WalletAccount(s2, this._wallet, h, void 0);
  }
  async chainId() {
    if (!this._wallet)
      throw new A();
    const s2 = await this._wallet.request({
      type: "wallet_requestChainId"
    }), t = Oa(s2);
    return BigInt(t);
  }
  async initEventListener(s2) {
    if (this._wallet = l, !this._wallet)
      throw new A();
    this._wallet.on("accountsChanged", s2);
  }
  async removeEventListener(s2) {
    if (this._wallet = l, !this._wallet)
      throw new A();
    this._wallet.off("accountsChanged", s2), l = null, h = null, this._wallet = null;
  }
  async ensureWallet() {
    const s2 = this._options.url || fn;
    Na({
      origin: s2,
      location: "/interstitialLogin"
    }), l = await et(s2) ?? null, this._wallet = l;
  }
};
var ct = (a) => {
  document.addEventListener(P, () => {
    a();
  });
};
export {
  L as ConnectAndSignSessionError,
  P as WEBWALLET_LOGOUT_EVENT,
  lt as WebWalletConnector,
  B as WebwalletError,
  ct as handleWebwalletLogoutEvent
};
//# sourceMappingURL=starknetkit_webwallet.js.map
